#!/usr/bin/env bash

if [[ $EUID -ne 0 ]]; then
    echo "error: root required" 
    exit 1
fi

if systemctl list-units --type=service | grep -q keyd; then
    echo "keyd service exists"
else
    echo "installing keyd"
    git clone https://github.com/rvaiya/keyd
    cd keyd || exit 1
    if ! make && sudo make install; then
        echo "error: keyd install failed"
        exit 1
    fi
    cd .. || exit 1
    trap 'rm -rf keyd' EXIT
    echo "keyd installed"
fi

if ! sudo systemctl enable --now keyd; then
    echo "error: keyd service failed"
    exit 1
fi

cat <<EOF > /etc/keyd/default.conf
[ids]

*
[main]

# Maps k to escape when pressed and ~control~ capslock when held
capslock = esc

# Remaps the escape key to capslock
esc = capslock
EOF
echo "keyd config mapped"

sudo keyd reload

# systemctl status keyd --no-pager

